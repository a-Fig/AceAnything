<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California DMV Prep – Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #000000;
            --bg-card: #1c1c1e;
            --bg-element: #2c2c2e;
            --bg-element-hover: #3a3a3c;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --accent-blue: #0A84FF;
            --accent-blue-hover: #0077EE;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --border-color: #38383a;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --success-glow: rgba(48, 209, 88, 0.35);
            --error-glow: rgba(255, 69, 58, 0.35);
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-main);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Changed to flex-start for better layout with footer */
            min-height: 100vh;
            padding: 1.5rem;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .quiz-viewport { width: 100%; max-width: 680px; margin-top: 2vh; margin-bottom: auto;} /* Added margin-top and margin-bottom auto */

        .quiz-card {
            background-color: var(--bg-card);
            border-radius: 22px;
            box-shadow: 0 16px 32px rgba(0,0,0,0.25), 0 0 0 0.5px rgba(255,255,255,0.08);
            padding: clamp(1.75rem, 5vw, 2.75rem);
            transition: box-shadow 0.4s ease-out, transform 0.3s ease-out;
            /* margin: auto 0; Removed for quiz-viewport to handle centering */
        }
        .quiz-card-glow-correct { box-shadow: 0 16px 32px rgba(0,0,0,0.25), 0 0 0 0.5px rgba(255,255,255,0.08), 0 0 22px 5px var(--success-glow); }
        .quiz-card-glow-incorrect { box-shadow: 0 16px 32px rgba(0,0,0,0.25), 0 0 0 0.5px rgba(255,255,255,0.08), 0 0 22px 5px var(--error-glow); }
        @keyframes card-shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); }
        }
        .quiz-card-shake-animation { animation: card-shake 0.35s cubic-bezier(.36,.07,.19,.97) both; }

        .btn {
            padding: 0.8rem 1.6rem; border-radius: 10px; font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none; cursor: pointer; font-size: 0.95rem;
            letter-spacing: 0.01em; text-transform: none;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: var(--accent-blue); color: white; }
        .btn-primary:hover { background-color: var(--accent-blue-hover); transform: scale(1.03); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background-color: var(--bg-element); color: var(--text-secondary); cursor: not-allowed; transform: none; }

        .btn-secondary { background-color: var(--bg-element); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--bg-element-hover); transform: scale(1.03); }
        .btn-secondary:active { transform: scale(0.98); }

        .mcq-option-group { margin-bottom: 1.75rem; display: flex; flex-direction: column; gap: 0.625rem; }
        .mcq-option {
            display: flex; align-items: center; position: relative; cursor: pointer;
            font-size: 1rem; font-weight: 500;
            background-color: var(--bg-element);
            padding: 0.875rem 1.125rem; border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s, border-color 0.2s;
            color: var(--text-primary);
        }
        .mcq-option:hover { background-color: var(--bg-element-hover); border-color: #505052; }
        .mcq-option input[type="radio"] { display: none; }
        .mcq-option .radio-custom-outer {
            width: 20px; height: 20px; border: 2px solid #5e5e61;
            border-radius: 50%; margin-right: 0.875rem; display: flex;
            align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
        }
        .mcq-option .radio-custom-inner {
            width: 10px; height: 10px; background-color: transparent;
            border-radius: 50%; transform: scale(0); transition: transform 0.2s ease-out;
        }
        .mcq-option input[type="radio"]:checked + .radio-custom-outer { border-color: var(--accent-blue); }
        .mcq-option input[type="radio"]:checked + .radio-custom-outer .radio-custom-inner { background-color: var(--accent-blue); transform: scale(1); }
        .mcq-option-text { flex-grow: 1; line-height: 1.5; color: var(--text-primary); }

        .tf-options-container { display: grid; grid-template-columns: 1fr 1fr; gap: 0.625rem; margin-bottom: 1.75rem; }
        .tf-btn {
            padding: 0.875rem; border-radius: 10px; cursor: pointer;
            text-align: center; font-weight: 600; font-size: 1rem;
            background-color: var(--bg-element); color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }
        .tf-btn:hover { background-color: var(--bg-element-hover); border-color: #505052; }
        .tf-btn.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }

        #shortAnswerInput {
            background-color: var(--bg-element); color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 0.875rem 1.125rem;
            border-radius: 10px; width: 100%; margin-bottom: 1.75rem;
            font-size: 1rem; line-height: 1.6; resize: vertical; min-height: 100px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #shortAnswerInput::placeholder { color: var(--text-secondary); }
        #shortAnswerInput:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); outline: none;
        }

        #aiTutorPanel {
            position: fixed; top: 0; right: -100%; /* Initially off-screen */
            width: 100%; max-width: 450px; /* Max width for larger screens */
            height: 100vh; /* Full viewport height */
            background: rgba(28, 28, 30, 0.75); /* Semi-transparent background */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%); /* For Safari */
            box-shadow: -8px 0 25px rgba(0,0,0,0.35);
            padding: 1.75rem;
            transition: right 0.55s cubic-bezier(0.32, 0.94, 0.6, 1); /* Smooth slide-in/out */
            z-index: 1000; /* Ensure it's above other content */
            display: flex; flex-direction: column; /* For internal layout */
            color: var(--text-primary);
            border-left: 0.5px solid rgba(255,255,255,0.15); /* Subtle border */
        }
        #aiTutorPanel.active { right: 0; /* Slide in */ }

        .ai-tutor-header {
            display: flex; align-items: center; margin-bottom: 1.25rem;
            padding-bottom: 1.25rem; border-bottom: 0.5px solid var(--border-color);
        }
        .ai-tutor-icon-wrapper {
            width: 40px; height: 40px; margin-right: 0.875rem;
            background: var(--bg-element);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .ai-tutor-icon-wrapper svg { width: 22px; height: 22px; fill: var(--accent-blue); }
        #aiTutorPanel h2 { font-size: 1.375rem; font-weight: 700; color: var(--text-primary); }

        #chatMessages {
            flex-grow: 1; overflow-y: auto; margin-bottom: 1rem;
            padding: 0.25rem 0;
        }
        .chat-bubble-container {
            display: flex;
            align-items: flex-start; /* Align items to the start (top) */
            margin-bottom: 0.75rem;
            max-width: 95%; /* Prevent bubbles from taking full width */
        }
        .chat-bubble-container.user { margin-left: auto; flex-direction: row-reverse; /* User messages on the right */ }
        .chat-bubble-container.ai { margin-right: auto; /* AI messages on the left */ }

        .chat-bubble {
            padding: 0.75rem 1.125rem;
            border-radius: 18px; /* Rounded corners */
            word-wrap: break-word; /* Wrap long words */
            line-height: 1.55; font-size: 0.95rem;
            opacity: 0; transform: translateY(8px); animation: bubbleUp 0.35s ease-out forwards;
            min-height: 1.5em; /* Ensure some height */
            color: var(--text-primary);
        }
        @keyframes bubbleUp { to { opacity: 1; transform: translateY(0); } }

        .chat-bubble.user { background-color: var(--accent-blue); color: white; }
        .chat-bubble.ai { background-color: var(--bg-element); color: var(--text-primary); }
        .chat-bubble.ai strong { color: var(--text-primary); font-weight: 600; }
        .chat-bubble.ai em { color: var(--text-secondary); font-style: normal; } /* Using normal style for emphasis */
        .chat-bubble.ai code {
            background-color: rgba(0,0,0,0.25); color: var(--accent-blue);
            padding: 0.15em 0.4em; border-radius: 5px; font-size: 0.9em;
            font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .feedback-status-icon { font-size: 1.1em; margin-right: 0.4rem; line-height: 1; vertical-align: -0.1em; }

        .tts-speaker-button {
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; padding: 0.3rem; /* Adjusted padding */
            margin-left: 0.5rem; margin-right: 0.2rem; /* Adjusted margin */
            opacity: 0.7;
            transition: opacity 0.2s, color 0.2s, transform 0.2s;
            align-self: center; /* Vertically center button with bubble text */
        }
        .chat-bubble-container.user .tts-speaker-button { margin-left: 0; margin-right: 0.5rem;}
        .tts-speaker-button:hover { opacity: 1; color: var(--accent-blue); transform: scale(1.1); }
        .tts-speaker-button svg { width: 18px; height: 18px; display: block; }

        /* Icon states for TTS button */
        .tts-speaker-button.playing svg, .tts-speaker-button.paused.can-resume svg { /* Pause icon when playing or paused but can resume */
             /* Using a pause SVG icon */
        }
        .tts-speaker-button.loading svg { animation: spinSpeaker 1s linear infinite; }
         /* Default is play icon (speaker) */

        @keyframes pulseSpeaker { from { transform: scale(1); } to { transform: scale(1.15); } }
        @keyframes spinSpeaker { to { transform: rotate(360deg); } }


        #chatInputContainer { display: flex; gap: 0.625rem; align-items: center; }
        #chatInput {
            flex-grow: 1; background-color: var(--bg-element); color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 0.625rem 0.875rem; border-radius: 8px; font-size: 0.95rem;
        }
        #chatInput::placeholder { color: var(--text-secondary); }
        #chatInput:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); outline: none;
        }
        #sendChatBtn {
            padding: 0.625rem; background-color: var(--accent-blue); border-radius: 8px;
            flex-shrink: 0;
        }
        #sendChatBtn:hover { background-color: var(--accent-blue-hover); }
        #sendChatBtn svg { width: 18px; height: 18px; fill: white; }

        #closeTutorBtn {
            position: absolute; top: 1rem; right: 1rem; background: transparent; border: none;
            color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; line-height: 1;
            padding: 0.375rem; border-radius: 50%; transition: color 0.2s, background-color 0.2s;
        }
        #closeTutorBtn:hover { color: var(--text-primary); background-color: rgba(255,255,255,0.1); }

        #scoreDisplay { font-size: 1.1rem; font-weight: 500; color: var(--text-secondary); }
        #questionText {
            font-size: clamp(1.25rem, 4vw, 1.75rem);
            font-weight: 600;
            line-height: 1.5; margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .app-header { margin-bottom: 2rem; text-align: center; }
        .app-title {
            font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 700;
            color: var(--text-primary);
            padding-bottom: 0.25rem;
            line-height: 1.2;
        }
        .app-subtitle { font-size: 0.95rem; color: var(--text-secondary); font-weight: 400; }

        .spinner {
            width: 18px; height: 18px;
            border: 2.5px solid var(--bg-element);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #postAnswerActions { margin-top: 1.25rem; display: flex; gap: 0.625rem; justify-content: center; }

        /* Footer styling */
        .app-footer {
            width: 100%;
            text-align: center;
            padding: 1.5rem 0 1rem 0; /* Add some padding */
            font-size: 0.75rem; /* Smaller text */
            color: var(--text-secondary);
            margin-top: auto; /* Pushes footer to bottom if content is short */
        }


        @media (max-width: 600px) {
            body { padding: 1rem; }
            .quiz-viewport { margin-top: 1rem; }
            .quiz-card { padding: clamp(1.25rem, 4vw, 2rem); border-radius: 18px; }
            #aiTutorPanel { max-width: 100%; border-left: none; border-radius: 0; padding: 1.25rem; }
            #aiTutorPanel h2 { font-size: 1.25rem; }
            .ai-tutor-icon-wrapper { width: 32px; height: 32px; margin-right: 0.625rem;}
            .ai-tutor-icon-wrapper svg { width: 18px; height: 18px; }
            .btn { padding: 0.75rem 1.25rem; font-size: 0.9rem; }
            #questionText { font-size: clamp(1.1rem, 3.8vw, 1.5rem); }
            .mcq-option { font-size: 0.9rem; padding: 0.75rem 1rem; }
            .tf-btn { font-size: 0.9rem; padding: 0.75rem; }
            .app-title { font-size: clamp(1.5rem, 4.5vw, 2rem); }
            .app-subtitle { font-size: 0.85rem; }
            #postAnswerActions { flex-direction: column; }
            #postAnswerActions .btn { width: 100%; }
            .app-footer { font-size: 0.7rem; }
        }

    </style>
</head>
<body>
    <div class="quiz-viewport">
        <div class="quiz-card" id="quizCard">
            <header class="app-header">
                <h1 class="app-title">AceDMV</h1>
                <p class="app-subtitle">California Driver Prep - Master the Road Rules</p>
                <p id="scoreDisplay" class="mt-3">Score: 0 / 0</p>
            </header>

            <div id="loadingMessage" class="text-center py-10 text-base">
                <div class="spinner mx-auto mb-3" style="width: 32px; height: 32px; border-width: 3px;"></div>
                Loading Next Question...
            </div>

            <div id="quizArea" class="hidden">
                <div id="questionContainer">
                    <p id="questionText"></p>
                </div>

                <div id="answerOptionsMcq" class="mcq-option-group"></div>
                <div id="answerOptionsTf" class="tf-options-container"></div>
                <div id="shortAnswerContainer" class="hidden">
                    <textarea id="shortAnswerInput" rows="4" placeholder="Type your answer here..."></textarea>
                </div>

                <button id="submitAnswerBtn" class="btn btn-primary w-full mt-4">Submit Answer</button>

                <div id="postAnswerActions" class="hidden">
                    <button id="reviewWithCoachBtn" class="btn btn-secondary">Review with Coach</button>
                    <button id="nextQuestionSimpleBtn" class="btn btn-primary">Next Question</button>
                </div>
            </div>

            <div id="quizEndMessage" class="text-center text-2xl font-semibold py-10 hidden">
                <span class="block text-4xl mb-2">🎉</span>
                Quiz Complete!
                <p class="text-lg font-normal text-gray-400 mt-1">Great work, you're ready to ace it!</p>
            </div>
        </div>
    </div>

    <div id="aiTutorPanel">
        <button id="closeTutorBtn" aria-label="Close tutor panel">&times;</button>
        <div class="ai-tutor-header">
            <div class="ai-tutor-icon-wrapper">
                <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.5-11.5c.83 0 1.5-.67 1.5-1.5S11.33 5.5 10.5 5.5 9 6.17 9 7s.67 1.5 1.5 1.5zm3 0c.83 0 1.5-.67 1.5-1.5S14.33 5.5 13.5 5.5 12 6.17 12 7s.67 1.5 1.5 1.5zm-3 4C8.67 12.5 7 13.84 7 15.5h10c0-1.66-1.67-3-4.5-3S8.67 12.5 7.5 12.5z"/></svg>
            </div>
            <h2>AI Driving Coach</h2>
        </div>
        <div id="chatMessages">
            </div>
        <div class="mt-auto pt-4"> <div id="chatInputContainer" class="flex items-center gap-2">
                <input type="text" id="chatInput" placeholder="Ask AI Coach..." aria-label="Chat input">
                <button id="sendChatBtn" class="btn !p-3" aria-label="Send message">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M1.946 9.315c-.522-.174-.527-.455.014-.634L21.043 2.315c.54-.183.848.123.67.648L16.253 22.042c-.178.534-.48.532-.662.004L12 14l-8 3.614L1.946 9.315zM12 14l.001 6.001L15.613 22.042 21.725 2.958 1.956 8.685 8 12l4-2z"/></svg>
                </button>
            </div>
            <button id="nextQuestionFromChatBtn" class="btn btn-primary w-full mt-3 hidden">Next Challenge</button>
        </div>
    </div>

    <footer class="app-footer"> &copy; <span id="currentYear"></span> California DMV Prep Pro. Interface Version 3.2
    </footer>

    <script>
        // DOM Elements
        const quizCard = document.getElementById('quizCard');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const loadingMessage = document.getElementById('loadingMessage');
        const quizArea = document.getElementById('quizArea');
        const questionText = document.getElementById('questionText');
        const answerOptionsMcq = document.getElementById('answerOptionsMcq');
        const answerOptionsTf = document.getElementById('answerOptionsTf');
        const shortAnswerContainer = document.getElementById('shortAnswerContainer');
        const shortAnswerInput = document.getElementById('shortAnswerInput');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const postAnswerActions = document.getElementById('postAnswerActions');
        const reviewWithCoachBtn = document.getElementById('reviewWithCoachBtn');
        const nextQuestionSimpleBtn = document.getElementById('nextQuestionSimpleBtn');
        const quizEndMessage = document.getElementById('quizEndMessage');
        const aiTutorPanel = document.getElementById('aiTutorPanel');
        const closeTutorBtn = document.getElementById('closeTutorBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const nextQuestionFromChatBtn = document.getElementById('nextQuestionFromChatBtn');
        document.getElementById('currentYear').textContent = new Date().getFullYear();


        // State
        let currentQuestionType = '';
        let currentQuestionData = null; // Holds data for the current question from backend
        let selectedMcqOptionValue = null; // e.g., 'A', 'B'
        let selectedTfOptionValue = null; // 'True' or 'False' (string)
        let lastAnswerData = null; // Stores the full response from /submit-answer

        // Audio state
        let globalAudioContext = null; // To unlock audio on user gesture
        let currentPlayingAudio = null; // The Audio object currently playing or paused
        let currentPlayingButton = null; // The button associated with currentPlayingAudio
        let audioCache = {}; // Cache for audio blobs/URLs { text: audioURL }

        // --- SVG Icons --- (Used for dynamic button state changes)
        const playIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;
        const pauseIconSVG = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;
        const loadingIconSVG = `<svg class="animate-spin" style="animation-name: spinSpeaker;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity=".3"></circle><path d="M4 12a8 8 0 018-8" stroke-linecap="round"></path></svg>`;


        // --- UI Control ---
        function openTutorPanel() {
            aiTutorPanel.classList.add('active');
            // Consider disabling body scroll when panel is open for better UX on mobile
            // document.body.style.overflow = 'hidden';
        }

        function closeTutorPanel() {
            stopCurrentAudio(); // Stop audio when closing panel
            aiTutorPanel.classList.remove('active');
            // document.body.style.overflow = '';
        }

        function stopCurrentAudio() {
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.src = ''; // Release resource
                if (currentPlayingButton) {
                    updateSpeakerIcon(currentPlayingButton, 'default');
                }
                currentPlayingAudio = null;
                currentPlayingButton = null;
            }
        }


        function triggerCardAnimation(isCorrect) {
            quizCard.classList.remove('quiz-card-glow-correct', 'quiz-card-glow-incorrect', 'quiz-card-shake-animation');
            void quizCard.offsetWidth; // Trigger reflow to restart animation
            if (isCorrect) {
                quizCard.classList.add('quiz-card-glow-correct');
            } else {
                quizCard.classList.add('quiz-card-glow-incorrect');
                quizCard.classList.add('quiz-card-shake-animation');
            }
        }

        // --- Quiz Flow ---
        async function fetchQuestion() {
            loadingMessage.classList.remove('hidden');
            quizArea.classList.add('hidden');
            postAnswerActions.classList.add('hidden');
            submitAnswerBtn.classList.remove('hidden');
            // closeTutorPanel(); // Don't close tutor if it was intentionally opened.
            nextQuestionFromChatBtn.classList.add('hidden');
            submitAnswerBtn.disabled = false;
            submitAnswerBtn.innerHTML = 'Submit Answer';
            quizCard.classList.remove('quiz-card-glow-correct', 'quiz-card-glow-incorrect', 'quiz-card-shake-animation');
            stopCurrentAudio(); // Stop any audio from previous question's chat

            try {
                const response = await fetch('/api/get-question'); // FastAPI handles session via cookie
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                currentQuestionData = data; // Store the raw data from backend

                if (data.quiz_ended || data.error) {
                    quizArea.classList.add('hidden');
                    loadingMessage.classList.add('hidden');
                    closeTutorPanel(); // Close tutor at the end of the quiz
                    quizEndMessage.classList.remove('hidden');
                    quizEndMessage.innerHTML = data.error ? `⚠️ ${data.error}` : `<span class="block text-4xl mb-3">🎉</span>Quiz Complete!<p class="text-lg font-normal text-gray-400 mt-1">Final Score: ${data.score || 0} / ${data.questions_answered || 0}</p>`;
                    scoreDisplay.textContent = `Final Score: ${data.score || 0} / ${data.questions_answered || 0}`;
                    return;
                }

                quizEndMessage.classList.add('hidden');
                questionText.innerHTML = (data.question || "Error loading question text.").replace(/\n/g, '<br>');
                currentQuestionType = data.question_type; // 'mcq', 'short_answer' (backend might send 'tf' as 'mcq' with specific options)
                updateScoreDisplay(data.score, data.questions_answered);

                // Clear previous options
                answerOptionsMcq.innerHTML = '';
                answerOptionsTf.innerHTML = '';
                shortAnswerInput.value = '';
                selectedMcqOptionValue = null;
                selectedTfOptionValue = null;

                // Hide all option containers initially
                answerOptionsMcq.classList.add('hidden');
                answerOptionsTf.classList.add('hidden');
                shortAnswerContainer.classList.add('hidden');

                if (currentQuestionType === 'mcq' && data.options && data.options.length > 0) {
                    // Check if it's True/False based on options content
                    const isTrueFalse = data.options.length === 2 &&
                                        data.options.map(opt => String(opt).toLowerCase()).includes("true") &&
                                        data.options.map(opt => String(opt).toLowerCase()).includes("false");

                    if (isTrueFalse) {
                        answerOptionsTf.classList.remove('hidden');
                        // Order of True/False buttons can be fixed or based on data.options order
                        const trueOpt = data.options.find(o => String(o).toLowerCase() === "true");
                        const falseOpt = data.options.find(o => String(o).toLowerCase() === "false");

                        // Create buttons in a consistent order (e.g., True then False)
                        if (trueOpt !== undefined) { // Check if "True" is an option
                            const buttonTrue = document.createElement('button');
                            buttonTrue.classList.add('tf-btn');
                            buttonTrue.textContent = "True";
                            buttonTrue.dataset.value = "True"; // Store the string "True"
                            buttonTrue.onclick = () => selectTfOption(buttonTrue, "True");
                            answerOptionsTf.appendChild(buttonTrue);
                        }
                        if (falseOpt !== undefined) { // Check if "False" is an option
                            const buttonFalse = document.createElement('button');
                            buttonFalse.classList.add('tf-btn');
                            buttonFalse.textContent = "False";
                            buttonFalse.dataset.value = "False"; // Store the string "False"
                            buttonFalse.onclick = () => selectTfOption(buttonFalse, "False");
                            answerOptionsTf.appendChild(buttonFalse);
                        }
                         currentQuestionType = 'tf'; // Explicitly set type for submission logic
                    } else { // Regular MCQ
                        answerOptionsMcq.classList.remove('hidden');
                        const letters = ['A', 'B', 'C', 'D', 'E', 'F']; // Support up to F
                        data.options.forEach((option, index) => {
                            if (index >= letters.length) return; // Safety for too many options
                            const label = document.createElement('label');
                            label.classList.add('mcq-option');
                            const input = document.createElement('input');
                            input.type = 'radio'; input.name = 'mcqOption'; input.value = letters[index];
                            input.onchange = () => selectedMcqOptionValue = letters[index];

                            const customRadioOuter = document.createElement('span'); customRadioOuter.classList.add('radio-custom-outer');
                            const customRadioInner = document.createElement('span'); customRadioInner.classList.add('radio-custom-inner');
                            customRadioOuter.appendChild(customRadioInner);

                            const optionTextSpan = document.createElement('span'); optionTextSpan.classList.add('mcq-option-text');
                            optionTextSpan.textContent = `${letters[index]}. ${option}`;

                            label.appendChild(input); label.appendChild(customRadioOuter); label.appendChild(optionTextSpan);
                            answerOptionsMcq.appendChild(label);
                        });
                    }
                } else if (currentQuestionType === 'short_answer') {
                    shortAnswerContainer.classList.remove('hidden');
                } else {
                     console.error("Unknown question type or missing options:", data);
                     questionText.innerHTML = "Error: Could not display question options.";
                }
                loadingMessage.classList.add('hidden');
                quizArea.classList.remove('hidden');
            } catch (error) {
                console.error('Failed to fetch question:', error);
                loadingMessage.innerHTML = `⚠️ Failed to load question: ${error.message}. Please refresh.`;
                // Optionally, you could try to re-fetch after a delay or show a manual refresh button
            }
        }

        function selectTfOption(buttonElement, value) {
            // Deselect other TF button
            document.querySelectorAll('.tf-btn.selected').forEach(btn => btn.classList.remove('selected'));
            // Select clicked button
            buttonElement.classList.add('selected');
            selectedTfOptionValue = value; // value is 'True' or 'False' (string)
        }


        async function handleSubmitAnswer() {
            let userAnswerPayload; // This will be the value sent to the backend

            if (currentQuestionType === 'tf') { // True/False questions
                if (selectedTfOptionValue) {
                    // Backend expects 'A' or 'B' if it's treated as MCQ.
                    // We need to map 'True'/'False' to the corresponding letter based on currentQuestionData.options
                    const trueIndex = currentQuestionData.options.findIndex(opt => String(opt).toLowerCase() === "true");
                    const falseIndex = currentQuestionData.options.findIndex(opt => String(opt).toLowerCase() === "false");
                    const letters = ['A', 'B'];

                    if (selectedTfOptionValue === "True" && trueIndex !== -1) {
                        userAnswerPayload = letters[trueIndex];
                    } else if (selectedTfOptionValue === "False" && falseIndex !== -1) {
                        userAnswerPayload = letters[falseIndex];
                    } else {
                         alert('Error processing True/False selection. Please try again.'); return;
                    }
                } else {
                    alert('Please select True or False.'); return;
                }
            } else if (currentQuestionType === 'mcq') { // Regular MCQ
                if (selectedMcqOptionValue) {
                    userAnswerPayload = selectedMcqOptionValue; // 'A', 'B', etc.
                } else {
                    alert('Please select an option.'); return;
                }
            } else if (currentQuestionType === 'short_answer') {
                userAnswerPayload = shortAnswerInput.value.trim();
                if (!userAnswerPayload) {
                    alert('Please enter an answer.'); return;
                }
            } else {
                alert('Unknown question type. Cannot submit.'); return;
            }

            submitAnswerBtn.disabled = true;
            submitAnswerBtn.innerHTML = `<div class="spinner mr-2"></div> Processing...`;

            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answer: userAnswerPayload }) // Send the determined payload
                });
                if (!response.ok) { // Handle non-2xx responses
                    const errorData = await response.json().catch(() => ({ detail: "Unknown error during submission." }));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail}`);
                }
                const data = await response.json();
                lastAnswerData = data; // Store for potential review

                updateScoreDisplay(data.score, data.questions_answered);
                triggerCardAnimation(data.correct);

                // Clear previous AI messages before adding new ones
                chatMessages.innerHTML = '';
                submitAnswerBtn.classList.add('hidden'); // Hide submit while showing post-answer options or tutor

                if (data.correct) {
                    postAnswerActions.classList.remove('hidden'); // Show "Review with Coach" / "Next Question"
                    if (data.ai_messages && data.ai_messages.length > 0) {
                        // If correct and there are AI messages (e.g. positive reinforcement), show them in tutor panel
                        addAIMessagesToChat(data.ai_messages, data.correct);
                        // Don't auto-open tutor for correct answers unless specifically designed
                    }
                } else { // Incorrect answer
                    postAnswerActions.classList.add('hidden'); // Don't show simple next/review for incorrect, force tutor flow
                    if (data.ai_messages && data.ai_messages.length > 0) {
                        addAIMessagesToChat(data.ai_messages, data.correct);
                    } else { // Fallback AI message if backend provides none
                        let fallbackMsg = `<span class="feedback-status-icon">⚠️</span> <strong>Let's review that.</strong> `;
                        if(data.reason) fallbackMsg += `${data.reason.replace(/\n/g, '<br>')}<br><br>`;
                        let explanation = (currentQuestionData && currentQuestionData.explanation_preview) ? currentQuestionData.explanation_preview : "The handbook provides detailed guidance.";
                        fallbackMsg += `<em>Key Point:</em> ${explanation.replace(/\n/g, '<br>')}`;
                        addMessageToChat(fallbackMsg, 'ai', true); // true for isFirstAIMessage styling
                        addMessageToChat("I'm here to help clarify this. What part was confusing, or would you like more details on a specific aspect?", 'ai');
                    }
                    openTutorPanel();
                    nextQuestionFromChatBtn.classList.remove('hidden'); // Show "Next Challenge" in tutor panel
                }
            } catch (error) {
                console.error('Failed to submit answer:', error);
                chatMessages.innerHTML = ''; // Clear chat on error
                addMessageToChat(`<span class="feedback-status-icon">⚠️</span> <strong>Error!</strong><br>Could not submit answer: ${error.message}`, 'ai', true);
                addMessageToChat("Apologies, there was an issue submitting your answer. Please try again or click 'Next Challenge' if available.", 'ai');
                openTutorPanel(); // Open tutor to show error
                nextQuestionFromChatBtn.classList.remove('hidden'); // Allow user to move on
                postAnswerActions.classList.add('hidden'); // Hide normal post-answer actions
            } finally {
                 // Ensure submit button is re-enabled if no other action takes its place
                 if (!postAnswerActions.classList.contains('hidden') || aiTutorPanel.classList.contains('active')) {
                    submitAnswerBtn.classList.add('hidden'); // Keep hidden if post-actions or tutor is up
                 } else {
                    submitAnswerBtn.disabled = false;
                    submitAnswerBtn.innerHTML = 'Submit Answer';
                    submitAnswerBtn.classList.remove('hidden'); // Show if no other flow started
                 }
            }
        }

        function addAIMessagesToChat(messages, isCorrectContext) {
            if (messages && messages.length > 0) {
                let firstMessageContent = messages[0];
                let visualPrefix = '';
                if (isCorrectContext === true) {
                    visualPrefix = `<span class="feedback-status-icon" style="color: var(--accent-green);">🎉</span> `;
                } else if (isCorrectContext === false) {
                    visualPrefix = `<span class="feedback-status-icon" style="color: var(--accent-red);">⚠️</span> `;
                }
                // Add prefix only to the first message of this batch
                addMessageToChat(visualPrefix + firstMessageContent, 'ai', true); // true for isFirstAIMessage

                for (let i = 1; i < messages.length; i++) {
                    addMessageToChat(messages[i], 'ai'); // Subsequent messages don't get the prefix again
                }
            }
        }


        async function handleSendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            addMessageToChat(message, 'user');
            chatInput.value = '';
            sendChatBtn.disabled = true;
            const originalSendBtnContent = sendChatBtn.innerHTML;
            sendChatBtn.innerHTML = `<div class="spinner" style="width:18px; height:18px; border-width:2px;"></div>`;

            if (message.toLowerCase() === 'next' || message.toLowerCase() === 'next question') {
                addMessageToChat("Okay, let's move to the next question!", 'ai');
                sendChatBtn.disabled = false; sendChatBtn.innerHTML = originalSendBtnContent;
                fetchQuestion(); // This will also close tutor if it's designed to
                closeTutorPanel(); // Explicitly close tutor when "next" is typed
                return;
            }
            try {
                const response = await fetch('/api/chat-with-tutor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ detail: "Unknown chat error." }));
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.detail}`);
                }
                const data = await response.json();

                if (data.ai_messages && data.ai_messages.length > 0) {
                    data.ai_messages.forEach(msg => addMessageToChat(msg, 'ai'));
                }
                if (data.move_next) { // If AI decides it's time for next question
                    fetchQuestion();
                    closeTutorPanel();
                }
            } catch (error) {
                console.error('Failed to send chat message:', error);
                addMessageToChat(`⚠️ My apologies, I encountered a connection hiccup: ${error.message}. Could you try that again?`, 'ai');
            } finally {
                sendChatBtn.disabled = false; sendChatBtn.innerHTML = originalSendBtnContent;
                chatInput.focus(); // Keep focus on input
            }
        }

        function addMessageToChat(message, sender, isFirstAIMessage = false) {
            const bubbleContainer = document.createElement('div');
            bubbleContainer.classList.add('chat-bubble-container', sender);

            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender);
            bubble.style.color = (sender === 'user') ? 'white' : 'var(--text-primary)';

            let finalMessage = message.replace(/\n/g, '<br>');
            if (sender === 'ai') { // Basic markdown-like replacements for AI messages
                finalMessage = finalMessage.replace(/\`([^\`]+)\`/g, '<code>$1</code>'); // Code backticks
                finalMessage = finalMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                finalMessage = finalMessage.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics
            }
            bubble.innerHTML = finalMessage;
            bubbleContainer.appendChild(bubble);

            if (sender === 'ai') {
                const speakerButton = document.createElement('button');
                speakerButton.classList.add('tts-speaker-button');
                speakerButton.setAttribute('aria-label', 'Play message audio');
                speakerButton.innerHTML = playIconSVG; // Default to play icon
                // Sanitize text for TTS: remove HTML tags for cleaner speech
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = message; // Let browser parse HTML
                const textToSpeak = tempDiv.textContent || tempDiv.innerText || "";
                speakerButton.dataset.textForTTS = textToSpeak;

                speakerButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent click from bubbling up if needed
                    playTTSText(speakerButton);
                };
                bubbleContainer.appendChild(speakerButton);
            }
            chatMessages.appendChild(bubbleContainer);
            // Scroll to bottom smoothly after a short delay to allow rendering
            setTimeout(() => { chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' }); }, 50);
        }

        function updateSpeakerIcon(buttonElement, state) { // state: 'loading', 'playing', 'paused', 'default'
            if (!buttonElement) return;
            buttonElement.classList.remove('loading', 'playing', 'paused', 'can-resume');
            let icon = playIconSVG; // Default

            if (state === 'loading') {
                buttonElement.classList.add('loading');
                icon = loadingIconSVG;
            } else if (state === 'playing') {
                buttonElement.classList.add('playing');
                icon = pauseIconSVG;
            } else if (state === 'paused') { // Audio is paused, icon should be 'play' to resume
                buttonElement.classList.add('paused', 'can-resume');
                icon = playIconSVG;
            }
            buttonElement.innerHTML = icon;
        }


        async function playTTSText(buttonElement) {
            if (!globalAudioContext) { // Attempt to unlock audio context on first TTS click
                globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (globalAudioContext.state === 'suspended') {
                    await globalAudioContext.resume();
                }
            }

            const textToSpeak = buttonElement.dataset.textForTTS;

            if (currentPlayingButton === buttonElement) { // Clicking the same button
                if (currentPlayingAudio && !currentPlayingAudio.paused) { // It's playing, so pause it
                    currentPlayingAudio.pause();
                    updateSpeakerIcon(buttonElement, 'paused');
                } else if (currentPlayingAudio && currentPlayingAudio.paused) { // It's paused, so resume it
                    currentPlayingAudio.play().catch(e => console.error("Error resuming audio:", e));
                    updateSpeakerIcon(buttonElement, 'playing');
                }
                return; // Handled toggle
            }

            // If other audio is playing, stop it and reset its button
            if (currentPlayingAudio) {
                currentPlayingAudio.pause();
                currentPlayingAudio.src = ''; // Release resource
                if (currentPlayingButton) {
                    updateSpeakerIcon(currentPlayingButton, 'default');
                }
            }

            currentPlayingAudio = null; // Clear previous audio
            currentPlayingButton = buttonElement; // Set new button as current
            updateSpeakerIcon(buttonElement, 'loading');

            const cachedAudioUrl = audioCache[textToSpeak];
            if (cachedAudioUrl) {
                currentPlayingAudio = new Audio(cachedAudioUrl);
            } else {
                try {
                    const response = await fetch('/api/tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: textToSpeak })
                    });
                    if (!response.ok) {
                        const errData = await response.json().catch(() => null);
                        throw new Error(`TTS generation failed: ${response.status} ${errData ? errData.detail : response.statusText}`);
                    }
                    const audioBlob = await response.blob();
                    const newAudioUrl = URL.createObjectURL(audioBlob);
                    audioCache[textToSpeak] = newAudioUrl; // Cache for future use
                    currentPlayingAudio = new Audio(newAudioUrl);
                } catch (error) {
                    console.error('Error fetching or creating TTS audio:', error);
                    addMessageToChat(`⚠️ TTS Error: ${error.message}`, 'ai');
                    updateSpeakerIcon(buttonElement, 'default');
                    currentPlayingButton = null; // Reset current button on error
                    return;
                }
            }

            if (!currentPlayingAudio) { // Should not happen if logic above is correct
                 updateSpeakerIcon(buttonElement, 'default');
                 currentPlayingButton = null;
                 return;
            }

            currentPlayingAudio.play().then(() => {
                updateSpeakerIcon(buttonElement, 'playing');
            }).catch(e => {
                console.error("Error playing audio:", e);
                updateSpeakerIcon(buttonElement, 'default');
                currentPlayingButton = null; // Reset on playback error
            });

            currentPlayingAudio.onended = () => {
                updateSpeakerIcon(buttonElement, 'default');
                // Don't revoke from cache immediately, keep it for session
                if (currentPlayingButton === buttonElement) { // Ensure it's the same button that ended
                    currentPlayingAudio = null;
                    currentPlayingButton = null;
                }
            };
            currentPlayingAudio.onerror = (e) => {
                console.error("Audio playback error event:", e);
                updateSpeakerIcon(buttonElement, 'default');
                if (currentPlayingButton === buttonElement) {
                    currentPlayingAudio = null;
                    currentPlayingButton = null;
                }
            };
        }


        function updateScoreDisplay(currentScore, answeredCount) {
            scoreDisplay.textContent = `Score: ${currentScore} / ${answeredCount}`;
        }

        // --- Event Listeners & Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attempt to initialize AudioContext on any first user interaction
            const unlockAudio = () => {
                if (!globalAudioContext) {
                    globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (globalAudioContext.state === 'suspended') {
                        globalAudioContext.resume().then(() => {
                            console.log("AudioContext resumed on user gesture.");
                        }).catch(e => console.error("Error resuming AudioContext:", e));
                    }
                }
                document.body.removeEventListener('click', unlockAudio, true);
                document.body.removeEventListener('keydown', unlockAudio, true);
            };
            document.body.addEventListener('click', unlockAudio, true);
            document.body.addEventListener('keydown', unlockAudio, true);


            fetchQuestion(); // Initial question load

            submitAnswerBtn.addEventListener('click', handleSubmitAnswer);
            sendChatBtn.addEventListener('click', handleSendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendChatBtn.disabled) {
                    e.preventDefault(); handleSendChatMessage();
                }
            });
            nextQuestionFromChatBtn.addEventListener('click', () => {
                fetchQuestion();
                closeTutorPanel(); // Close tutor when "Next Challenge" is clicked
            });
            closeTutorBtn.addEventListener('click', closeTutorPanel);

            reviewWithCoachBtn.addEventListener('click', () => {
                if (lastAnswerData) { // Ensure there's data from the last answer
                    chatMessages.innerHTML = ''; // Clear previous messages
                    // If there were specific AI messages from the backend for this answer, show them
                    if (lastAnswerData.ai_messages && lastAnswerData.ai_messages.length > 0) {
                        addAIMessagesToChat(lastAnswerData.ai_messages, lastAnswerData.correct);
                    } else {
                        // Fallback if no AI messages were provided but review is clicked
                        let reviewMsg = lastAnswerData.correct ?
                            `You got it right! The reason was: "${lastAnswerData.reason || 'Well done!'}"` :
                            `Let's look at that again. The reason given was: "${lastAnswerData.reason || 'No specific reason provided.'}"`;
                        addMessageToChat(reviewMsg, 'ai', true);
                        addMessageToChat(`The explanation for this is: ${currentQuestionData.explanation_preview || currentQuestionData.explanation}`, 'ai');
                        addMessageToChat("What would you like to discuss further?", 'ai');
                    }
                    openTutorPanel();
                    nextQuestionFromChatBtn.classList.remove('hidden'); // Show "Next Challenge" in tutor
                    postAnswerActions.classList.add('hidden'); // Hide the main "Review/Next" buttons
                } else {
                    // Fallback if reviewWithCoachBtn is somehow active without lastAnswerData
                    addMessageToChat("There's no specific answer data to review currently. How can I help you with the last question?", 'ai', true);
                    openTutorPanel();
                    nextQuestionFromChatBtn.classList.remove('hidden');
                    postAnswerActions.classList.add('hidden');
                }
            });
            nextQuestionSimpleBtn.addEventListener('click', () => {
                fetchQuestion();
                // Optionally close tutor if it was opened for a correct answer review
                // if (aiTutorPanel.classList.contains('active')) {
                //    closeTutorPanel();
                // }
            });
        });
    </script>
</body>
</html>
